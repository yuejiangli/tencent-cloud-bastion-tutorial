# 🚀 デプロイメントチェックリスト

Tencent Cloud VPC ネットワークアーキテクチャをデプロイする前に、以下のチェック項目を完了してください：

## ✅ デプロイ前チェック

### 1. 環境準備
- [ ] Terraform のインストール (>= 1.0)
- [ ] jq のインストール (JSON 処理用)
- [ ] Tencent Cloud API 認証情報の設定
- [ ] SSH キーペアの生成

### 2. 権限チェック
- [ ] Tencent Cloud アカウントに VPC リソース作成権限があること
- [ ] Tencent Cloud アカウントに CVM インスタンス作成権限があること
- [ ] Tencent Cloud アカウントに Elastic IP 作成権限があること
- [ ] リージョンクォータ制限の確認

### 3. 設定チェック
- [ ] `terraform.tfvars` ファイルのコピーと編集
- [ ] VPC CIDR が既存ネットワークと競合しないことの確認
- [ ] 対象リージョンでインスタンスタイプが利用可能であることの確認
- [ ] 対象リージョンでイメージ ID が利用可能であることの確認

### 4. セキュリティチェック
- [ ] SSH アクセス IP 範囲の制限 (本番環境)
- [ ] セキュリティグループルールがセキュリティ要件を満たしていることの確認
- [ ] キーペアの安全な保存の確認

## 🔧 デプロイ手順

### 1. 初期化
```bash
make init
```

### 2. 設定の検証
```bash
make validate
```

### 3. 実行計画の確認
```bash
make plan
```

### 4. 設定の適用
```bash
make apply
```

## ✅ デプロイ後検証

### 1. インフラストラクチャ検証
- [ ] VPC の作成成功
- [ ] サブネットの作成成功 (パブリック/プライベート)
- [ ] インターネットゲートウェイの正しい設定
- [ ] NAT ゲートウェイの作成成功
- [ ] ルートテーブルの正しい設定

### 2. インスタンス検証
- [ ] 踏み台サーバーインスタンスの正常動作
- [ ] Web サーバーインスタンスの正常動作
- [ ] Elastic IP のバインド成功
- [ ] セキュリティグループルールの有効化

### 3. ネットワーク接続性検証
```bash
# 踏み台サーバーへの接続
make ssh-bastion

# 踏み台サーバーでのネットワークテスト
ping 8.8.8.8  # インターネット接続テスト
ping <web-server-private-ip>  # 内部ネットワーク接続テスト

# Web サーバーへの接続
make ssh-web

# Web サーバーでのテスト
ping 8.8.8.8  # NAT ゲートウェイ経由のインターネット接続テスト
curl http://httpbin.org/ip  # 外部 IP が NAT ゲートウェイ IP であることの確認
```

### 4. サービス検証
```bash
# 踏み台サーバーサービスの確認
ssh ubuntu@<bastion-ip> "bastion-status"

# Web サーバーサービスの確認
ssh -J ubuntu@<bastion-ip> ubuntu@<web-ip> "web-status"

# Web サービスの確認
curl -H "Host: test.local" http://<web-private-ip>/
curl -H "Host: test.local" http://<web-private-ip>:8080/api/info
```

## 🔒 セキュリティ検証

### 1. ネットワークセキュリティ
- [ ] プライベートサブネットインスタンスにパブリック IP がないこと
- [ ] プライベートサブネットインスタンスがインターネットから直接アクセスできないこと
- [ ] 踏み台サーバーがプライベートサブネットインスタンスにアクセスできること
- [ ] セキュリティグループルールが期待通りに動作すること

### 2. アクセス制御
- [ ] SSH キー認証が正常に動作すること
- [ ] パスワード認証が無効化されていること
- [ ] ファイアウォールルールが正しく設定されていること
- [ ] fail2ban サービスが正常に動作していること

### 3. 監査とモニタリング
- [ ] SSH セッションログが正常に記録されていること
- [ ] システムモニタリングスクリプトが利用可能であること
- [ ] ヘルスチェックエンドポイントが正常に応答すること

## 📊 パフォーマンス検証

### 1. ネットワークパフォーマンス
```bash
# ネットワーク遅延のテスト
ping -c 10 <target-ip>

# 帯域幅のテスト (iperf3 のインストールが必要)
# サーバー側: iperf3 -s
# クライアント側: iperf3 -c <server-ip>
```

### 2. システムパフォーマンス
```bash
# システム負荷の確認
uptime
htop

# ディスクパフォーマンスの確認
iostat -x 1 5

# ネットワーク接続の確認
ss -tuln
netstat -i
```

## 🚨 トラブルシューティング

### よくある問題のチェック

#### 1. SSH 接続失敗
```bash
# セキュリティグループルールの確認
terraform output bastion_security_group_id

# インスタンス状態の確認
terraform show | grep -A 10 "tencentcloud_instance.bastion"

# ネットワーク接続性のテスト
telnet <bastion-ip> 22
```

#### 2. インスタンスがインターネットにアクセスできない
```bash
# ルートテーブルの確認
terraform output | grep route

# NAT ゲートウェイ状態の確認
terraform show | grep -A 10 "tencentcloud_nat_gateway"

# インスタンス上でのルート確認
ip route show
```

#### 3. Web サービスにアクセスできない
```bash
# サービス状態の確認
systemctl status nginx
systemctl status webapp

# ポート監視の確認
ss -tuln | grep -E ':(80|443|8080)'

# ファイアウォールの確認
ufw status
```

## 📋 メンテナンスチェックリスト

### 日常メンテナンス
- [ ] システムアップデートの確認
- [ ] ディスク使用率の監視
- [ ] ログファイルサイズの確認
- [ ] バックアップ戦略の検証

### 定期メンテナンス
- [ ] システムパッチの更新
- [ ] ログファイルのローテーション
- [ ] セキュリティ設定の確認
- [ ] モニタリングスクリプトの更新

### セキュリティメンテナンス
- [ ] アクセスログの監査
- [ ] SSH キーの更新
- [ ] セキュリティグループルールの確認
- [ ] ファイアウォールルールの更新

## 🧹 リソースクリーンアップ

### リソース破棄前チェック
- [ ] データが不要であることの確認
- [ ] 重要な設定とデータのバックアップ
- [ ] 関連チームメンバーへの通知
- [ ] 依存リソースがないことの確認

### 破棄コマンド
```bash
make destroy
```

## 📞 緊急連絡先

### 技術サポート
- Tencent Cloud 技術サポート: [チケットシステム](https://console.cloud.tencent.com/workorder)
- 内部技術チーム: [連絡先情報]

### モニタリングアラート
- モニタリングシステム: [モニタリング URL]
- アラート通知: [アラート設定]

---

**注意**: 本番環境へのデプロイ前に、すべての項目を慎重にチェックし、会社のセキュリティとコンプライアンス要件を満たしていることを確認してください。